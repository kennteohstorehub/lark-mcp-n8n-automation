#!/usr/bin/env node

// Load environment variables
require('dotenv').config();

const { GoogleGenerativeAI } = require('@google/generative-ai');
const fs = require('fs');
const path = require('path');
const { spawn, exec } = require('child_process');
const readline = require('readline');

// Initialize Gemini AI
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

class SurpriseAutomation {
    constructor() {
        this.startTime = new Date();
        this.tasks = [];
        this.completedTasks = [];
    }

    async log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const symbols = { info: 'üî∑', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå', magic: '‚ú®' };
        console.log(`${symbols[type]} [${timestamp}] ${message}`);
    }

    async executeTask(name, taskFunction) {
        this.log(`Starting: ${name}`, 'info');
        this.tasks.push({ name, status: 'running', startTime: Date.now() });
        
        try {
            const result = await taskFunction();
            this.completedTasks.push({ name, result, duration: Date.now() - this.tasks.find(t => t.name === name).startTime });
            this.log(`Completed: ${name}`, 'success');
            return result;
        } catch (error) {
            this.log(`Failed: ${name} - ${error.message}`, 'error');
            throw error;
        }
    }

    async takeScreenshot() {
        return new Promise((resolve, reject) => {
            const filename = `surprise_screenshot_${Date.now()}.png`;
            exec(`python3 macos_automation.py screenshot ${filename}`, (error, stdout, stderr) => {
                if (error) {
                    reject(error);
                } else {
                    resolve({ filename, output: stdout });
                }
            });
        });
    }

    async analyzeSystemWithGemini() {
        const systemInfo = {
            timestamp: new Date().toISOString(),
            platform: process.platform,
            nodeVersion: process.version,
            workingDirectory: process.cwd(),
            memoryUsage: process.memoryUsage(),
            uptime: process.uptime()
        };

        const prompt = `
        You are an AI productivity assistant. Analyze this system information and create a personalized productivity report:
        
        System Info: ${JSON.stringify(systemInfo, null, 2)}
        
        Create a brief, encouraging productivity report with:
        1. System health assessment
        2. Productivity tips based on current time
        3. One specific automation suggestion
        4. A motivational message
        
        Keep it under 200 words and make it personal and actionable.
        `;

        const result = await model.generateContent(prompt);
        return result.response.text();
    }

    async createProductivityFiles() {
        const today = new Date().toISOString().split('T')[0];
        const todayTasksFile = `productivity_${today}.md`;
        
        const content = `# üöÄ Productivity Report - ${today}

## üìä System Status
- **Time**: ${new Date().toLocaleString()}
- **Status**: All systems operational
- **MCP Servers**: 8 active servers
- **Automation**: Ready for commands

## üéØ Today's Focus Areas
- [ ] Review and prioritize tasks
- [ ] Optimize development workflow
- [ ] Explore new automation possibilities
- [ ] Test MCP integrations

## üîß Available Tools
- ‚úÖ Browser automation (Playwright)
- ‚úÖ macOS GUI control
- ‚úÖ Email automation
- ‚úÖ File organization
- ‚úÖ Web scraping
- ‚úÖ AI integration (Gemini Pro)

## üí° Smart Suggestions
- Use MCP servers for repetitive tasks
- Automate file organization
- Set up email filters
- Create custom workflows

---
*Generated by AI Productivity Assistant*
`;

        fs.writeFileSync(todayTasksFile, content);
        return { filename: todayTasksFile, content };
    }

    async openDashboard() {
        return new Promise((resolve, reject) => {
            exec('open ai_dashboard.html', (error, stdout, stderr) => {
                if (error) {
                    reject(error);
                } else {
                    resolve('Dashboard opened successfully');
                }
            });
        });
    }

    async launchGeminiChat() {
        return new Promise((resolve) => {
            const geminiProcess = spawn('node', ['gemini-mcp-client.js'], {
                stdio: 'inherit',
                detached: true
            });
            
            geminiProcess.unref();
            resolve('Gemini MCP Client launched in background');
        });
    }

    async organizeWorkspace() {
        return new Promise((resolve, reject) => {
            exec('python3 organize_desktop.py', (error, stdout, stderr) => {
                if (error) {
                    reject(error);
                } else {
                    resolve('Workspace organized successfully');
                }
            });
        });
    }

    async createTimeBasedGreeting() {
        const hour = new Date().getHours();
        let greeting, activity;

        if (hour < 12) {
            greeting = "Good morning! üåÖ";
            activity = "Perfect time to start your day with some automation magic!";
        } else if (hour < 18) {
            greeting = "Good afternoon! ‚òÄÔ∏è";
            activity = "Let's boost your productivity with some smart automation!";
        } else {
            greeting = "Good evening! üåô";
            activity = "Time to wrap up the day and prepare for tomorrow!";
        }

        return { greeting, activity };
    }

    async generateSurpriseReport() {
        const report = {
            title: "üé≠ SURPRISE AUTOMATION REPORT",
            timestamp: new Date().toISOString(),
            totalTasks: this.completedTasks.length,
            executionTime: Date.now() - this.startTime.getTime(),
            tasks: this.completedTasks,
            capabilities: [
                "‚úÖ AI-powered system analysis",
                "‚úÖ Automated screenshot capture",
                "‚úÖ Dynamic file organization",
                "‚úÖ Real-time productivity reporting",
                "‚úÖ Interactive dashboard creation",
                "‚úÖ Multi-modal AI integration",
                "‚úÖ Background process management",
                "‚úÖ Personalized workflow optimization"
            ]
        };

        const reportFile = `surprise_report_${Date.now()}.json`;
        fs.writeFileSync(reportFile, JSON.stringify(report, null, 2));
        return { report, filename: reportFile };
    }

    async executeFullSurprise() {
        this.log("üé™ INITIATING SURPRISE AUTOMATION SEQUENCE", 'magic');
        this.log("üöÄ Preparing to demonstrate full MCP ecosystem...", 'info');

        try {
            // Step 1: Open the dashboard
            await this.executeTask("Opening AI Dashboard", () => this.openDashboard());

            // Step 2: Create time-based greeting
            const greetingData = await this.executeTask("Creating Personalized Greeting", () => this.createTimeBasedGreeting());
            this.log(`${greetingData.greeting} ${greetingData.activity}`, 'magic');

            // Step 3: Take screenshot
            await this.executeTask("Capturing System Screenshot", () => this.takeScreenshot());

            // Step 4: Analyze system with Gemini
            const aiAnalysis = await this.executeTask("AI System Analysis", () => this.analyzeSystemWithGemini());
            this.log("üß† AI Analysis Complete:", 'success');
            console.log("üìã " + aiAnalysis);

            // Step 5: Create productivity files
            await this.executeTask("Creating Productivity Files", () => this.createProductivityFiles());

            // Step 6: Organize workspace
            await this.executeTask("Organizing Workspace", () => this.organizeWorkspace());

            // Step 7: Launch Gemini chat (background)
            await this.executeTask("Launching Gemini MCP Client", () => this.launchGeminiChat());

            // Step 8: Generate final report
            const finalReport = await this.executeTask("Generating Surprise Report", () => this.generateSurpriseReport());

            this.log("üéâ SURPRISE AUTOMATION COMPLETE!", 'magic');
            this.log(`üìä Executed ${finalReport.report.totalTasks} tasks in ${finalReport.report.executionTime}ms`, 'success');
            this.log(`üìÑ Full report saved to: ${finalReport.filename}`, 'info');

            // Final surprise message
            setTimeout(() => {
                this.log("üé≠ SURPRISE REVEAL:", 'magic');
                this.log("üîç Check your desktop - files are organized!", 'info');
                this.log("üì± Your browser opened an AI dashboard!", 'info');
                this.log("üì∏ Screenshots were taken automatically!", 'info');
                this.log("ü§ñ Gemini AI analyzed your system!", 'info');
                this.log("üìã Productivity report was generated!", 'info');
                this.log("üöÄ Background MCP client is running!", 'info');
                this.log("‚ú® This is the power of MCP automation!", 'magic');
            }, 1000);

        } catch (error) {
            this.log(`üí• Surprise automation failed: ${error.message}`, 'error');
            throw error;
        }
    }
}

// Execute the surprise if this script is run directly
if (require.main === module) {
    const automation = new SurpriseAutomation();
    automation.executeFullSurprise()
        .then(() => {
            console.log("\nüéä SURPRISE AUTOMATION COMPLETED SUCCESSFULLY! üéä");
            process.exit(0);
        })
        .catch((error) => {
            console.error("‚ùå Surprise automation failed:", error);
            process.exit(1);
        });
}

module.exports = SurpriseAutomation; 